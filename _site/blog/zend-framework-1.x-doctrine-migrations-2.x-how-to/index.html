<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title>Zend Framework 1.x + Doctrine Migrations 2.x - How to</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <meta name="description" content="A tutorial on how to setup Doctrine Migrations with Zend Framework 1"/>
        <meta name="author" content="Martin Shwalbe"/>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.0.4/css/bootstrap-combined.min.css" rel="stylesheet"/>
        <link href="/js/google-code-prettify/sunburst.css" type="text/css" rel="stylesheet" />
        <link href="/css/style.css" rel="stylesheet"/>
	   <link href="/css/docs.css" rel="stylesheet"/>
    </head>
    <body data-spy="scroll" data-target=".subnav" data-offset="50">
        <div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>
            <a style="float:right;margin:5px 15px;" href="/feed/feed.rss" title="RSS Feed"><img src="/img/feed-icon-28x28.png" alt="RSS Feed"/></a>

            <a class="brand" href="http://hounddog.github.com">Martin Shwalbe</a>
            <div class="nav-collapse">
                <ul class="nav">
                    <li class="">
                        <a href="http://hounddog.github.com">Home</a>
                    </li>
                    <li class="divider-vertical"></li>
                    <li class="">
                        <a href="http://github.com/hounddog" target="_blank">GitHub</a>
                    </li>
                    <li class="divider-vertical"></li>
                    <li class="">
                        <a href="http://linkedin.com/in/mshwalbe" title="Go to Martin Shwalbe's LinkedIn profile" target="_blank">LinkedIn</a>
                    </li>
                    <li class="divider-vertical"></li>
                    <li class="">
                        <a href="http://www.twitter.com/mshwalbe" title="Martin Shwalbe's Twitter profile" target="_blank">Twitter</a>
                    </li>
                    <li class="divider-vertical"></li>
                    <li class="">
                        <a href="/resume" title="Martin Shwalbe's Resume">Resume</a>
                    </li>
                    <li class="divider-vertical"></li>
                </ul>
            </div>
        </div>
    </div>
</div>

        <div class="container">
            <div class="marketing">
                <div class="content">
    <div class="row">

    <div class="span3 column">
        <h4>
            <strong>
                October  5, 2012
                <small>
                    . Coding .
                    <a href="http://hounddog.github.com/blog/zend-framework-1.x-doctrine-migrations-2.x-how-to#disqus_thread" data-disqus-identifier="/blog/zend-framework-1.x-doctrine-migrations-2.x-how-to">Comments</a>
                </small>
            </strong>
            <br/>
            <small>
                Tags:
                
                <a href="/tags/Zend" title="View posts tagged with &quot;Zend&quot;"><u>Zend</u></a>
                 
                
                <a href="/tags/Framework" title="View posts tagged with &quot;Framework&quot;"><u>Framework</u></a>
                 
                
                <a href="/tags/Doctrine" title="View posts tagged with &quot;Doctrine&quot;"><u>Doctrine</u></a>
                 
                
                <a href="/tags/Tutorial" title="View posts tagged with &quot;Tutorial&quot;"><u>Tutorial</u></a>
                
                
            </small>
        </h4>
    </div>
    <div class="span9 column">
        <p class="pull-right">
            
            <a href="/blog/continuous-deployment-1" title="Previous Post: My Journey in Continuous Deployment">
                <i class="icon-chevron-left"></i>
            </a>
            
            
            <a href="/blog/using-traits-in-zend-framework-2" title="Next Post: Using Traits with Zend Framework 2">
                <i class="icon-chevron-right"></i>
            </a>
            
        </p>
        <p>
            <a class="btn btn-mini btn-warning" href="https://github.com/Hounddog/hounddog.github.com/issues/new" target="_blank">
                Report an issue
            </a>
            <a class="btn btn-mini btn-success" href="https://github.com/Hounddog/hounddog.github.com/fork_select" target="_blank">
                Fork and help me
            </a>
        </p>
    </div>

    <div class="row">
        <div class="span12 column">
            <hr/>
        </div>
    </div>

    <h1>Zend Framework 1.x + Doctrine Migrations 2.x - How to</h1>

    <div class="row">
        <div class="span12 column">
            <hr/>
        </div>
    </div>

</div>

    <div class="row well">
    <iframe
        src="http://ghbtns.com/github-btn.html?user=Hounddog&type=follow&count=true"
        allowtransparency="true"
        frameborder="0"
        scrolling="0"
        width="160px"
        height="20px"
    ></iframe>
    <iframe
        src="http://ghbtns.com/github-btn.html?user=Hounddog&repo=hounddog.github.com&type=watch&count=true"
        allowtransparency="true"
        frameborder="0"
        scrolling="0"
        width="105px"
        height="20px"
    ></iframe>
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="mshwalbe">Tweet</a>
    <a href="https://twitter.com/mshwalbe" class="twitter-follow-button btn btn-mini" data-show-count="false">
        Follow @mshwalbe
    </a>
    <g:plusone size="medium"></g:plusone>
</div>
    <div class="row">
  <p>
    Hello everybody!
  </p>

  <p>
    PEM (on irc freenode #dojo) and me have worked hard to make something useful to you!
  </p>
  <p>
    I'm pretty sure some of you already encountered that situation when you feel like poping your eyes out because of incomplete documentations, or lack of help/support...
    If you are reading this, you most likely were about to throw away your computer in anger... Fear not! We will try to save your day :)
  <p>
  <p>Just follow the steps :</p>

  <ul>
    <li>
      You can have a look at my repository on github : <a href="https://github.com/PEM-FR/Doctrine2-ZendFramework1-Migrations-Setup" title="Doctrine Migration Scripts" target="_blank">Doctrine Migration Scripts for Zend Framework support</a>
    </li>
    <li>
      You have now two choices :
      <ul>
        <li>
          Integrates Migrations into your already existing Doctrine folder, in this path : Doctrine/DBAL/Migrations.
        </li>
        <li>
          Use Migrations as Standalone (in that case jump to step xxx).
        </li>
      </ul
    </li>
  </ul>
  <h3>USING MIGRATIONS INSIDE DOCTRINE FOLDER</h3>

  <ul>
    <li>
      So now basically you should have something like this :
      <ul>
       <li>Doctrine/DBAl/Migrations</li>
       <li>Doctrine/DBAl/Migrations/Configuration</li>
       <li>Doctrine/DBAl/Migrations/Tools</li>
       <li>Doctrine/DBAl/Migrations/Tools/Console</li>
       <li>Doctrine/DBAl/Migrations/Tools/Console/Command</li>
      </ul>
    </li>
    <li>In the *scripts* directory you should have a file called ZendConfiguration.php (if not something went wrong go back to step 1)</li>
    <li>If you have zend framework installed and running, with doctrine, you might want to create a file called doctrine.php (or whatever you like if you know already what we are talking about, or you could use the one provided in the scripts folder).</li>
  </ul>

  <p>doctrine.php should look like that (DO NOT FORGET TO EDIT THE FILE AND CHANGE THE PATHS)</p>
  <pre class="prettyprint linenums lang-prepro">
  // Display errors ?
  //ini_set('display_errors', 1);
  //error_reporting(E_ALL | E_STRICT);

  // Define path to application directory
  // DO NOT FORGET TO EDIT
  defined('APPLICATION_PATH')
      || define('APPLICATION_PATH','/path/to/your/application');

  // Define application environment
  defined('APPLICATION_ENV')
      || define(
          'APPLICATION_ENV',
          (getenv('APPLICATION_ENV') ? getenv('APPLICATION_ENV') : 'development')
      );

  // Ensure library/ is on include_path
  // DO NOT FORGET TO EDIT
  set_include_path(
      '/path/to/where/your/zend/library/is' . PATH_SEPARATOR .
      '/path/to/Doctrine' . PATH_SEPARATOR .
      get_include_path()
  );

  // Requiring a batch of Classes we will need for namespacing
  use Doctrine\Common\ClassLoader,
      Doctrine\DBAL\Tools\Console\Helper\ConnectionHelper,
      Doctrine\ORM\Version,
      Doctrine\ORM\Tools\Console\ConsoleRunner,
      Doctrine\ORM\Tools\Console\Helper\EntityManagerHelper,
      Symfony\Component\Console\Helper\HelperSet,
      Symfony\Component\Console\Helper\DialogHelper,
      Symfony\Component\Console\Application;

  // namespacing migrations commands we will be needing later
  use Doctrine\DBAL\Migrations\Tools\Console\Command\DiffCommand,
      Doctrine\DBAL\Migrations\Tools\Console\Command\ExecuteCommand,
      Doctrine\DBAL\Migrations\Tools\Console\Command\GenerateCommand,
      Doctrine\DBAL\Migrations\Tools\Console\Command\MigrateCommand,
      Doctrine\DBAL\Migrations\Tools\Console\Command\StatusCommand,
      Doctrine\DBAL\Migrations\Tools\Console\Command\VersionCommand;

  // We need the Doctrine ClassLoader to manage autoloading
  require_once 'Doctrine/Common/ClassLoader.php';

  // Load Doctrine
  $classLoader = new ClassLoader('Doctrine');
  $classLoader->register();

  // Load Symfony tools
  $classLoader = new ClassLoader('Symfony', 'Doctrine');
  $classLoader->register();

  // Load Migration
  $classLoader = new ClassLoader('Migrations', 'Doctrine/DBAL/');
  $classLoader->register();

  // Zend_Application
  require_once 'Zend/Application.php';

  // Create application
  // DO NOT FORGET TO EDIT
  $application = new Zend_Application(
      APPLICATION_ENV, '/path/to/application.ini'
  );

  // Bootstrap
  $application->bootstrap();

  // loading doctrine resource, sometimes called entityManager
  // DO NOT FORGET TO EDIT, set the resource to your entityManager
  $em = $application->getBootstrap()->getResource('db');

  // Load doctrine helpers
  $helperSet = new HelperSet(array(
      'db'     => new ConnectionHelper($em->getConnection()),
      'em'     => new EntityManagerHelper($em),
      'dialog' => new DialogHelper()
  ));

  $cli = new Application('Doctrine Command Line Interface', Version::VERSION);
  $cli->setCatchExceptions(true);
  $cli->setHelperSet($helperSet);

  // We are settign the commands to bypass the configuration process and
  // directly use our ZendConfiguration
  // Just make sure to load from where the file actually is
  require_once('ZendConfiguration.php');
  $connexion = $em->getConnection();
  $zendConfig = new ZendConfiguration($connexion);

  // injecting configurations necessary to our ZendConfiguration
  // Pass the Application.ini Parameters to our Configuration
  $applicationConfig = new Zend_Config(
      $application->getBootstrap()->getOptions(), true
  );
  // DO NOT FORGET TO EDIT, if needed
  $zendConfig->setConfig($applicationConfig->resources->db->migration);
  // Here we just need to put some string because the parameter is not optional
  // though will not need it. Just need to call the function
  $zendConfig->load('zend');

  // Setting up Migrations Commands
  $diffCmd = new DiffCommand();
  $diffCmd->setMigrationConfiguration($zendConfig);

  $executeCmd = new ExecuteCommand();
  $executeCmd->setMigrationConfiguration($zendConfig);

  $generateCmd = new GenerateCommand();
  $generateCmd->setMigrationConfiguration($zendConfig);

  $migrateCmd = new MigrateCommand();
  $migrateCmd->setMigrationConfiguration($zendConfig);

  $statusCmd = new StatusCommand();
  $statusCmd->setMigrationConfiguration($zendConfig);

  $versionCmd = new VersionCommand();
  $versionCmd->setMigrationConfiguration($zendConfig);


  // Register migration Commands
  $cli->addCommands(array(
      $diffCmd, $executeCmd, $generateCmd, $migrateCmd, $statusCmd, $versionCmd
  ));

  // Register All Doctrine Commands
  ConsoleRunner::addCommands($cli);

  // Runs console application
  $cli->run();
  </pre>
  <p>for some more information you might want to check this article : <a href="http://victimofbabylon.com/setting-up-doctrine-2-cli-with-zend-framework" title="Setting up doctrine 2 cli for zend framework" target="_blank">Setting up doctrine 2 cli for zend framework</a>
  <p>
  <p>We now have to tweak your Zend Framework application.ini file. Add these few lines :</p>
  <pre class="prettyprint linenums lang-prepro">
  ; ------------------------------------------------------------------------------
  ; Doctrine Migrations Configuration
  ; ------------------------------------------------------------------------------
  resources.db.migration.name = "YourSoft (development) Database Migrations"
  resources.db.migration.tableName = "doctrine_migration_versions"
  resources.db.migration.namespace = "DoctrineMigrations"
  resources.db.migration.directory = APPLICATION_PATH "/path/to/migrationsClass/directory"
  ;set the following two properties if you want to do manual naming on migration classes
  ;resources.doctrine.migration.migrations.migration1.version = "20111020071337"
  ;resources.doctrine.migration.migrations.migration1.class = "DoctrineMigrations\VersionNewMigration"
  </pre>
  <p>Now, try running from the scripts directory : </p>
  <pre class="prettyprint linenums lang-sh">
  ~$ php doctrine.php list migrations
  </pre>
  <p>As a result, you should see the commands available, something like that :</p>
  <pre class="prettyprint linenums lang-sh">
    Doctrine Command Line Interface version 2.2.1

    Usage:
      [options] command [arguments]

    Options:
      --help           -h Display this help message.
      --quiet          -q Do not output any message.
      --verbose        -v Increase verbosity of messages.
      --version        -V Display this program version.
      --ansi              Force ANSI output.
      --no-ansi           Disable ANSI output.
      --no-interaction -n Do not ask any interactive question.

    Available commands for the "migration" namespace:
      migrations:diff       Generate a migration by comparing your...
      migrations:execute    Execute a single migration version up or down manually.
      migrations:generate   Generate a blank migration class.
      migrations:migrate    Execute a migration to a specified version...
      migrations:status     View the status of a set of migrations.
      migrations:version    Manually add and delete migration versions...
    </pre>

  <p>You are now supposed to cry of joy and let a Victory shout be heard by the whole company :)</p>
</div>
</div>

<div class="row">
    <div class="span3 columns">&nbsp;</div>
    <div class="span9 column">
        <p class="pull-right">
            
            <a href="/blog/continuous-deployment-1" title="Previous Post: My Journey in Continuous Deployment">
                <i class="icon-chevron-left"></i>
            </a>
            
            
            <a href="/blog/using-traits-in-zend-framework-2" title="Next Post: Using Traits with Zend Framework 2">
                <i class="icon-chevron-right"></i>
            </a>
            
        </p>
    </div>
</div>

<hr/>
<div class="row well">
    <iframe
        src="http://ghbtns.com/github-btn.html?user=Hounddog&type=follow&count=true"
        allowtransparency="true"
        frameborder="0"
        scrolling="0"
        width="160px"
        height="20px"
    ></iframe>
    <iframe
        src="http://ghbtns.com/github-btn.html?user=Hounddog&repo=hounddog.github.com&type=watch&count=true"
        allowtransparency="true"
        frameborder="0"
        scrolling="0"
        width="105px"
        height="20px"
    ></iframe>
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="mshwalbe">Tweet</a>
    <a href="https://twitter.com/mshwalbe" class="twitter-follow-button btn btn-mini" data-show-count="false">
        Follow @mshwalbe
    </a>
    <g:plusone size="medium"></g:plusone>
</div>

<div class="row">
    <div class="span12 columns">
        <h2>Comments</h2>
        <p>Please feel free to leave any comments as long as they're related to the topic.</p>
        <div id="disqus_thread"></div>
    </div>
</div>
            </div>

            <footer class="footer">
	<p style="text-align:center">Zend Framework 1.x + Doctrine Migrations 2.x - How to updated on November 29, 2012</p>
</footer>

        </div>

        <script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.0.4/js/bootstrap.min.js"></script>
<script src="/js/google-code-prettify/prettify.js"></script>
<script src="/js/jquery.githubwidget.min.js"></script>
<script src="/js/custom.js"></script>
<script>$(prettyPrint);</script>
<script>
    var disqus_shortname = 'hounddog-dev';
    var disqus_identifier = '/blog/zend-framework-1.x-doctrine-migrations-2.x-how-to';
    var disqus_url = 'http://hounddog.github.com//blog/zend-framework-1.x-doctrine-migrations-2.x-how-to';
</script>
<script src="http://hounddog-dev.disqus.com/count.js"></script>
<script src="http://hounddog-dev.disqus.com/embed.js"></script>
<script src="http://platform.twitter.com/widgets.js"></script>
<script src="https://apis.google.com/js/plusone.js"></script>
<script src="/js/analytics.js"></script>
    </body>
</html>
